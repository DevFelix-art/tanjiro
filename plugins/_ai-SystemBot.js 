module.exports = {
  // Comandos con prefijo (ej: #s-status, #s-domain, #add-owner)
  command: ['s-status', 's-domain', 'add-owner'],
  tags: ['owner', 'system'],
  help: ['s-status', 's-domain <dominio> <suspended|actived>', 'add-owner <numero|mención|reply>'],

  /**
   * before: intercepta mensajes SIN prefijo (usamos para SystemBot-enable / SystemBot-disable
   * y para bloquear al owner cuando SystemBot está desactivado).
   * Devuelve true si maneja el mensaje (para que el framework no procese más).
   */
  before: async function (m, { conn }) {
    try {
      if (!m || !m.text) return false
      // Inicializar DB si hace falta
      if (!global.db) global.db = { data: {} }
      if (!global.db.data) global.db.data = {}
      if (!global.db.data.systembot) {
        global.db.data.systembot = {
          enabled: true,
          domains: {
            'kozow.com': true,
            'giize.com': true,
            'xo.je': true,
            'misite.site': true,
            'ooguy.com': true
          },
          owners: ['18094374392@s.whatsapp.net'],
          statusbot: `> Velocidad: 12 ms\n> Speed: 14\n> Webs manager: 6\n> Vps Manager: 0`
        }
      }
      const db = global.db.data.systembot

      const text = m.text.trim()
      const ltext = text.toLowerCase()

      // Resolver sender JID
      const sender = m.sender || (m.key && m.key.participant) || ''

      // Resolver si sender es owner autorizado (db.owners + global.owner fallback)
      const normalizedGlobalOwners = (global.owner && Array.isArray(global.owner))
        ? [...global.owner.map(([num]) => (num || '').toString())]
            .map(v => v.replace(/[^0-9]/g, '') + '@s.whatsapp.net')
        : []
      const isOwner = db.owners.includes(sender) || normalizedGlobalOwners.includes(sender)

      // Detectar SystemBot-enable / SystemBot-disable SIN prefijo (case-insensitive)
      if (ltext === 'systembot-enable' || ltext === 'systembot-disable') {
        if (!isOwner) {
          // opcional: responder que no tiene permisos
          if (m.reply) await m.reply('❌ Solo el owner puede usar este comando.')
          return true // mensaje manejado
        }
        if (ltext === 'systembot-enable') {
          if (db.enabled) {
            if (m.reply) await m.reply('✅ SystemBot ya estaba activado.')
            return true
          }
          db.enabled = true
          if (m.reply) await m.reply('✅ SystemBot online.')
          return true
        } else {
          // disable
          if (!db.enabled) {
            if (m.reply) await m.reply('❌ SystemBot ya estaba desactivado.')
            return true
          }
          db.enabled = false
          if (m.reply) await m.reply('❌ SystemBot Disabled.')
          return true
        }
      }

      // Si SystemBot está desactivado: ignorar TODO lo que haga el owner excepto el enable.
      // Para impedir que otros comandos con prefijo de este plugin se ejecuten cuando disabled,
      // retornamos true para que el framework no procese más. Esto evita que el owner ejecute
      // #s-status, #s-domain, #add-owner cuando esté en false.
      if (!db.enabled && isOwner) {
        // si quieres que NO responda a absolutamente nada, devolvemos true sin reacción.
        return true
      }

      return false
    } catch (e) {
      console.error('Error en _ai-SystemBot.before:', e)
      return false
    }
  },

  /**
   * handler: maneja comandos con prefijo (s-status, s-domain, add-owner)
   * Firma: handler(m, { conn, args, usedPrefix, command, text, isOwner })
   */
  handler: async function (m, { conn, args, usedPrefix, command, text }) {
    try {
      // Inicializar DB si hace falta (por seguridad)
      if (!global.db) global.db = { data: {} }
      if (!global.db.data) global.db.data = {}
      if (!global.db.data.systembot) {
        global.db.data.systembot = {
          enabled: true,
          domains: {
            'kozow.com': true,
            'giize.com': true,
            'xo.je': true,
            'misite.site': true,
            'ooguy.com': true
          },
          owners: ['18094374392@s.whatsapp.net'],
          statusbot: `> Velocidad: 12 ms\n> Speed: 14\n> Webs manager: 6\n> Vps Manager: 0`
        }
      }
      const db = global.db.data.systembot

      // Normalizar command y sender
      const cmd = (command || '').toString().toLowerCase()
      const sender = m.sender || (m.key && m.key.participant) || ''

      // resolver si sender es owner autorizado
      const normalizedGlobalOwners = (global.owner && Array.isArray(global.owner))
        ? [...global.owner.map(([num]) => (num || '').toString())]
            .map(v => v.replace(/[^0-9]/g, '') + '@s.whatsapp.net')
        : []
      const isOwner = db.owners.includes(sender) || normalizedGlobalOwners.includes(sender)
      if (!isOwner) return m.reply && await m.reply('❌ Solo el owner puede usar estos comandos.')

      // COMANDO: s-status
      if (cmd === 's-status' || cmd === 'sstatus') {
        const statusbot = db.statusbot
        const domainsArr = Object.keys(db.domains)
        const domainsbot = domainsArr.map(d => `> ${d}`).join('\n')

        const caption = `> Bot: SystemBot-V2\n\n*《◇》 STATUS BOT 《◇》*\n\n${statusbot}\n\n*《♡》 DOMAINS 《♡》*\n\n${domainsbot}`

        // Construir mensaje "quoted" para que aparezca como respuesta a "SystemBot-V2 | Online."
        const quotedFake = {
          key: {
            fromMe: false,
            // message id aleatorio (si el framework lo requiere)
            id: 'systembot-status-quoted',
            remoteJid: m.chat,
            participant: db.owners && db.owners[0] ? db.owners[0] : sender
          },
          message: {
            conversation: 'SystemBot-V2 | Online.'
          }
        }

        // Enviar imagen con caption y quote
        try {
          await conn.sendMessage(m.chat, {
            image: { url: 'https://q.ax/kqufhq.jpg' },
            caption
          }, { quoted: quotedFake })
        } catch (e) {
          // fallback: si la API es diferente, intentar usar m.reply
          try {
            await m.reply(caption + '\n\nhttps://q.ax/kqufhq.jpg')
          } catch (e2) {
            console.error('Error enviando s-status:', e, e2)
          }
        }
        return
      }

      // COMANDO: s-domain <dominio> <suspended|actived>
      if (cmd === 's-domain' || cmd === 'sdomain') {
        if (!args || args.length < 2) return m.reply && await m.reply('Uso: #s-domain <dominio> <suspended|actived>\nEj: #s-domain xo.je suspended')

        const domain = args[0].toLowerCase()
        const action = args[1].toLowerCase()

        if (!Object.prototype.hasOwnProperty.call(db.domains, domain)) {
          return m.reply && await m.reply('*❌ Dominio no reconocido. Dominios permitidos:*\n' + Object.keys(db.domains).map(d => `- ${d}`).join('\n'))
        }

        if (action === 'suspended') {
          if (!db.domains[domain]) {
            return m.reply && await m.reply('*ℹ️ El dominio ya estaba suspendido.*')
          }
          db.domains[domain] = false
          return m.reply && await m.reply('*✅ El dominio fue suspendido.*')
        } else if (action === 'actived' || action === 'activated' || action === 'activate') {
          if (db.domains[domain]) {
            return m.reply && await m.reply('*ℹ️ El dominio ya estaba activado.*')
          }
          db.domains[domain] = true
          return m.reply && await m.reply('*✅ El dominio fue activado y ya puedes ver o alojar tu web en el.*')
        } else {
          return m.reply && await m.reply('Acción inválida. Usa: suspended | actived\nEj: #s-domain xo.je suspended')
        }
      }

      // COMANDO: add-owner <numero|mención|reply>
      if (cmd === 'add-owner' || cmd === 'addowner') {
        // obtener target desde reply, m.mentionedJid o argumento numérico
        let target = null
        if (m.quoted && (m.quoted.sender || (m.quoted.key && m.quoted.key.participant))) {
          target = m.quoted.sender || (m.quoted.key && m.quoted.key.participant)
        } else if (m.mentionedJid && m.mentionedJid.length > 0) {
          target = m.mentionedJid[0]
        } else if (args && args.length > 0) {
          const digits = args[0].replace(/[^0-9]/g, '')
          if (digits) target = digits + '@s.whatsapp.net'
        }

        if (!target) return m.reply && await m.reply('Uso: #add-owner <numero|mención> o responde al mensaje de la persona.\nEj: #add-owner 5491112345678')

        // normalizar
        target = target.replace(/[^0-9@.]/g, '')
        if (!target.includes('@')) target = target + '@s.whatsapp.net'

        if (db.owners.includes(target)) {
          return m.reply && await m.reply('*ℹ️ Esta persona ya es owner autorizado.*')
        }

        db.owners.push(target)
        return m.reply && await m.reply('*✅ Owner agregado con éxito.*')
      }

    } catch (e) {
      console.error('Error en _ai-SystemBot.handler:', e)
      if (m.reply) try { await m.reply('Ocurrió un error interno al ejecutar el comando.') } catch (e2) {}
    }
  }
}